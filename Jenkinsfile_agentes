pipeline {
    
    agent none
    
    environment {
        
        GITHUB_TOKEN = 'unic-todo-token-access'
        
    }
    
    stages {
        
        stage('Get Code') {

            agent any

            steps {

                sh '''

                    whoami
                    hostname

                '''

                script {

                    def gitCredentialsId = GITHUB_TOKEN
                    checkout([$class: 'GitSCM', branches: [[name: '*/master'], [name: '*/develop']], userRemoteConfigs: [[url: 'https://github.com/GuillermoMC/todo-list-aws.git', credentialsId: gitCredentialsId]]])
                
                }
                
                sh '''

                    git checkout develop

                '''
                // descargar configuración para CI
                sh '''
                    curl -o samconfig-staging.toml https://raw.githubusercontent.com/GuillermoMC/todo-list-aws-config/refs/heads/staging/samconfig.toml
                '''

                stash name: 'proyecto', includes: '**'

            }
        }
        
      
        stage('Static Test') {
            
            parallel  {
                
                stage('Static') {
            
                    agent {  label 'agente1' }

                    steps {

                        unstash name: 'proyecto'

                        sh '''

                            whoami
                            hostname

                        '''
        
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
        
                            sh '''

                                flake8 --exit-zero --format=pylint src > flake8.out

                            '''
        
                            recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 0, type: 'TOTAL', unstable: true], [threshold: 1500, type: 'TOTAL', unstable: false]]
        
                        }
                    
                    }
                    
                }
                
                stage('Security') {
                    
                    agent { label 'agente1' }
                    
                    steps {

                        unstash name: 'proyecto'

                        sh '''

                            whoami
                            hostname

                        '''
        
                        catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                            
                            sh '''

                                bandit --exit-zero -r . -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"

                            '''
        
                            recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [[threshold: 0, type: 'TOTAL', unstable: true], [threshold: 1500, type: 'TOTAL', unstable: false]]
                            
                        }
        
                    }
                    
                }
                        
                
            }
            
            
        }
        
        stage('Deploy') {

            agent any
            
            steps {

                unstash name: 'proyecto'

                sh '''

                    whoami
                    hostname

                '''

                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                
                    sh '''

                        sam build
                    
                    '''

                    // tener en cuenta de que tiene que estar el s3 creado
                    // --no-execute-changeset se queda en CREATE_IN_PROGRESS

                    // antes -> sam deploy --no-fail-on-empty-changeset --config-file samconfig.toml --config-env staging --s3-bucket unir-cp-sam --stack-name todo-aws-list-staging
                    // ahora se especifica el fichero de configuración descargado para este CI
                    sh '''

                        sam deploy --no-fail-on-empty-changeset --config-file samconfig-staging.toml --s3-bucket unir-cp-sam
                    
                    '''

                }
                
            }
            
        }
        
        stage('Rest Test') {
    
            agent { label 'agente2' }
            
            steps {

                unstash name: 'proyecto'
                
                sh '''

                    whoami
                    hostname

                '''
                
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {

                    sh '''
                    
                        variable=$(aws cloudformation describe-stacks --stack-name todo-aws-list-staging --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" --output text)
                        
                        export BASE_URL=$variable
                        
                        pytest --junitxml=result-unit.xml test/integration/todoApiTest.py
                        
                    '''
                    
                    junit 'result*.xml'
                    
                }
                
            }
            
        }
        
        stage('Promote') {

            agent any
            
            steps {

                unstash name: 'proyecto'

                sh '''

                    whoami
                    hostname

                '''
                
               script {
                   
                   withCredentials([usernamePassword(credentialsId: GITHUB_TOKEN, usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_TOKEN')]) {
                       
                        // echo "creando fichero" > fichero_subida.txt
                        // git add fichero_subida.txt
                        // git commit -m "Subiendo un fichero nuevo desde un pipeline de Jenkins en AWS"
                        // git push https://\$GIT_USERNAME:\$GIT_TOKEN@github.com/GuillermoMC/todo-list-aws.git develop

                        sh '''

                            git checkout master
                            git pull
                            git config --global merge.ours.driver true
                            git merge --no-ff develop
                            git push https://\$GIT_USERNAME:\$GIT_TOKEN@github.com/GuillermoMC/todo-list-aws.git master 

                        '''
                        
                    }
                   
               }
                
            }
            
        }
        
    }
    
    post {

        always {

            script {

                def agents = ['principal', 'agente1', 'agente2']

                agents.each { agentName ->

                    node(agentName) {

                        cleanWs()

                    }

                }

            }

        }

    }
    
}